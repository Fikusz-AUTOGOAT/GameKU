<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Gothic 3D – Kolizje</title>
<style>
body { margin:0; overflow:hidden; background:#05070d; }
#hud {
 position:absolute; top:10px; left:10px;
 color:#e0d2a3; font-family:monospace;
 background:rgba(0,0,0,0.5); padding:10px;
}
</style>
</head>
<body>

<div id="hud">❤️ HP: <span id="hp">100</span></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
/* SCENA */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1020);
scene.fog = new THREE.Fog(0x0b1020,30,160);

const camera = new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,500);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* ŚWIATŁO */
scene.add(new THREE.AmbientLight(0x555555));
const sun = new THREE.DirectionalLight(0xffd9a0,1);
sun.position.set(50,100,20);
sun.castShadow=true;
scene.add(sun);

/* TEREN */
const groundGeo = new THREE.PlaneGeometry(300,300,80,80);
groundGeo.rotateX(-Math.PI/2);
for(let i=0;i<groundGeo.attributes.position.count;i++){
 groundGeo.attributes.position.setY(i,Math.random()*4);
}
groundGeo.computeVertexNormals();

const ground = new THREE.Mesh(
 groundGeo,
 new THREE.MeshStandardMaterial({color:0x2f5f2f})
);
ground.receiveShadow=true;
scene.add(ground);

/* DRZEWA + KOLIZJE */
const trees=[];
function addTree(x,z){
 const trunk = new THREE.Mesh(
  new THREE.CylinderGeometry(0.6,0.8,4),
  new THREE.MeshStandardMaterial({color:0x3b2a1a})
 );
 trunk.position.set(x,2,z);
 trunk.castShadow=true;
 trunk.userData.radius=1;
 trees.push(trunk);

 const leaves = new THREE.Mesh(
  new THREE.SphereGeometry(2),
  new THREE.MeshStandardMaterial({color:0x1f6f2a})
 );
 leaves.position.set(x,5,z);
 leaves.castShadow=true;

 scene.add(trunk,leaves);
}
for(let i=0;i<70;i++)
 addTree(Math.random()*200-100,Math.random()*200-100);

/* POSTAĆ – LEPSZY MODEL */
const player = new THREE.Group();

const body = new THREE.Mesh(
 new THREE.BoxGeometry(1,1.5,0.6),
 new THREE.MeshStandardMaterial({color:0x555555})
);
body.position.y=1.5;

const head = new THREE.Mesh(
 new THREE.SphereGeometry(0.4),
 new THREE.MeshStandardMaterial({color:0x777777})
);
head.position.y=2.6;

const legs = new THREE.Mesh(
 new THREE.BoxGeometry(0.8,1,0.5),
 body.material
);
legs.position.y=0.5;

player.add(body,head,legs);
player.position.set(0,3,0);
player.castShadow=true;
scene.add(player);

let playerHP=100;
let yaw=0;
const keys={};

/* STEROWANIE */
addEventListener("keydown",e=>keys[e.code]=true);
addEventListener("keyup",e=>keys[e.code]=false);

document.body.onclick=()=>document.body.requestPointerLock();
addEventListener("mousemove",e=>{
 if(document.pointerLockElement===document.body)
  yaw-=e.movementX*0.002;
});

/* RAYCAST – TEREN */
const downRay = new THREE.Raycaster();

/* KOLIZJA Z DRZEWAMI */
function treeCollision(oldPos){
 trees.forEach(t=>{
  const d = t.position.distanceTo(player.position);
  if(d < t.userData.radius + 0.6){
   player.position.copy(oldPos);
  }
 });
}

/* PĘTLA */
function animate(){
 requestAnimationFrame(animate);

 const oldPos = player.position.clone();
 const speed=0.12;

 const forward = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 const right = new THREE.Vector3(Math.sin(yaw+Math.PI/2),0,Math.cos(yaw+Math.PI/2));

 if(keys.KeyW) player.position.add(forward.clone().multiplyScalar(-speed));
 if(keys.KeyS) player.position.add(forward.clone().multiplyScalar(speed));
 if(keys.KeyA) player.position.add(right.clone().multiplyScalar(speed));
 if(keys.KeyD) player.position.add(right.clone().multiplyScalar(-speed));

 treeCollision(oldPos);

 /* WYSOKOŚĆ TERENU */
 downRay.set(
  new THREE.Vector3(player.position.x,50,player.position.z),
  new THREE.Vector3(0,-1,0)
 );
 const hit = downRay.intersectObject(ground);
 if(hit.length>0){
  player.position.y = hit[0].point.y + 1.5;
 }

 camera.position.set(
  player.position.x + Math.sin(yaw)*7,
  player.position.y + 4,
  player.position.z + Math.cos(yaw)*7
 );
 camera.lookAt(player.position);

 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

